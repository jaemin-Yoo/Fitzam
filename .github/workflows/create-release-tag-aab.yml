name: Release tag 생성 및 GitHub Artifacts AAB 파일 업로드

on:
  push:
    branches: ["main"]

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"
          cache: "gradle"

      - name: Read versionName
        id: version
        shell: bash
        run: |
          version_name=$(python - <<'PY'
          import re
          text = open("app/build.gradle.kts", encoding="utf-8").read()
          m = re.search(r'versionName\s*=\s*"(.*?)"', text)
          if not m:
              raise SystemExit("versionName not found")
          print(m.group(1))
          PY
          )
          echo "version_name=$version_name" >> "$GITHUB_OUTPUT"

      - name: Build release notes
        id: notes
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const sha = context.sha;
            const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner,
              repo,
              commit_sha: sha,
            });
            const pr = prs.data.find(p => p.merged_at) || prs.data[0];
            const body = pr?.body?.trim();
            const title = pr?.title?.trim();
            const fallback = (await github.rest.repos.getCommit({
              owner,
              repo,
              ref: sha,
            })).data.commit.message.trim();
            const notes = body || title || fallback;
            core.setOutput("notes", notes);

      - name: Grant execute permission for Gradle wrapper
        run: chmod +x ./gradlew

      - name: Decode upload keystore
        shell: bash
        run: |
          echo "$UPLOAD_KEYSTORE_BASE64" | base64 --decode > "$UPLOAD_KEYSTORE_PATH"
        env:
          UPLOAD_KEYSTORE_BASE64: ${{ secrets.UPLOAD_KEYSTORE_BASE64 }}
          UPLOAD_KEYSTORE_PATH: ${{ runner.temp }}/upload-keystore

      - name: Build release AAB
        run: ./gradlew bundleRelease
        env:
          KEYSTORE_PATH: ${{ runner.temp }}/upload-keystore
          KEYSTORE_PASSWORD: ${{ secrets.UPLOAD_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.UPLOAD_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.UPLOAD_KEY_PASSWORD }}

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-aab
          path: app/build/outputs/bundle/release/app-release.aab

      - name: Create tag
        shell: bash
        run: |
          tag="v${{ steps.version.outputs.version_name }}"
          if git rev-parse "$tag" >/dev/null 2>&1; then
            echo "Tag $tag already exists."
            exit 1
          fi
          git tag "$tag" "${{ github.sha }}"
          git push origin "$tag"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version_name }}
          name: v${{ steps.version.outputs.version_name }}
          body: ${{ steps.notes.outputs.notes }}
